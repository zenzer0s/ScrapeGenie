name: Deploy to Google Cloud VM

on:
  push:
    branches:
      - main
      - master

env:
  DOCKER_HUB_REPO: "${{ secrets.DOCKER_USERNAME }}/scrapegenie"
  VM_NAME: "${{ secrets.VM_NAME }}"
  VM_ZONE: "${{ secrets.VM_ZONE }}"
  SERVER_IP: "34.47.149.250"  # Your VM's IP address

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build & Push Docker Image
        run: |
          docker build -t ${{ env.DOCKER_HUB_REPO }}:latest .
          docker push ${{ env.DOCKER_HUB_REPO }}:latest

      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: "${{ secrets.GCP_SA_KEY }}"

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Deploy to VM
        run: |
          gcloud compute ssh $VM_NAME --zone=$VM_ZONE --command '
            # Create directories and ensure proper permissions
            mkdir -p ~/app/logs ~/app/data
            chmod -R 755 ~/app/logs ~/app/data
            
            # Create .env file (simpler approach)
            echo "TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}" > ~/app/.env
            echo "USE_WEBHOOK=false" >> ~/app/.env
            echo "PUBLIC_URL=http://${{ env.SERVER_IP }}:8080" >> ~/app/.env
            echo "BACKEND_URL=http://${{ env.SERVER_IP }}:8080" >> ~/app/.env
            echo "PORT=8080" >> ~/app/.env
            echo "NODE_ENV=production" >> ~/app/.env
            echo "PYTHON_PATH=/usr/bin/python3" >> ~/app/.env
            
            # Pull the latest Docker image
            sudo docker pull ${{ env.DOCKER_HUB_REPO }}:latest
            
            # Stop existing container if running
            sudo docker stop scrapegenie || true
            sudo docker rm scrapegenie || true
            
            # Start new container with explicit command (no line breaks)
            sudo docker run -d --name scrapegenie --restart unless-stopped -p 8080:8080 -v ~/app/logs:/app/logs -v ~/app/data:/app/data --env-file ~/app/.env ${{ env.DOCKER_HUB_REPO }}:latest
            
            # Clean up unused Docker resources
            sudo docker system prune -f
          '

      - name: Verify Deployment
        run: |
          gcloud compute ssh $VM_NAME --zone=$VM_ZONE --command '
            echo "Container Status:"
            sudo docker ps | grep scrapegenie || echo "ScrapeGenie is not running!"
            echo "Container Logs:"
            sudo docker logs --tail 20 scrapegenie || echo "No logs available."
          '

      - name: Show Output
        run: |
          echo "âœ… Deployed to http://${{ env.SERVER_IP }}:8080"
